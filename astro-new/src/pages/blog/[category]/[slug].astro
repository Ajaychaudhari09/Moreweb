---
import { render } from 'astro:content';
import Layout from "../../../layouts/Layout.astro";
import "@/styles/blog.css";
import AuthorBox from "../../../components/AuthorBox";
import TOC from "../../../components/TOC";
import ZoomProvider from "../../../components/ZoomProvider";
import ReadingProgress from "../../../components/ReadingProgress";
import SocialShareButtons from "../../../components/SocialShareButtons";
import AdsterraAd from "../../../components/AdsterraAd";
import { getAllPosts, getPrevNext } from "../../../lib/posts";

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post) => ({
    params: { category: post.category, slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post._astroEntry);
const { prev, next } = await getPrevNext(post.category, post.slug);

const canonicalURL = `https://morefusion.in/blog/${post.category}/${post.slug}`;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.title,
  description: post.excerpt,
  image: post.image || `https://morefusion.in/api/og?title=${encodeURIComponent(post.title)}`,
  datePublished: post.date,
  dateModified: post.date,
  author: {
    "@type": "Person",
    name: post.author,
  },
  publisher: {
    "@type": "Organization",
    name: "MoreFusion",
    logo: {
      "@type": "ImageObject",
      url: "https://morefusion.in/android-chrome-192x192.png",
    },
  },
  mainEntityOfPage: canonicalURL,
};

const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Blog",
      item: "https://morefusion.in/blog",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: post.category,
      item: `https://morefusion.in/blog/${post.category}`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: post.title,
      item: canonicalURL,
    },
  ],
};
---

<Layout title={`${post.title} | MoreFusion`} description={post.excerpt} image={post.image}>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbLd)} />

  <main class="bg-white dark:bg-gray-950">
    <ReadingProgress client:load />
    <ZoomProvider client:load />

    <div class="container mx-auto px-4 py-12 max-w-6xl">
      {/* Post Hero */}
      {/* Post Hero */}
      <div class={`relative mb-8 min-h-[300px] md:min-h-[450px] flex items-end overflow-hidden rounded-2xl ${post.category === 'AI' ? 'bg-indigo-900' : 'bg-gray-900'}`}>
        {post.image && (
          <img 
            src={post.image.includes('images.unsplash.com') ? `${post.image}?w=1200&q=80&auto=format&fit=crop` : post.image} 
            alt={post.title} 
            width="1200"
            height="675"
            decoding="async"
            class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 hover:scale-105" 
          />
        )}
        
        {/* Gradient Overlay - Stronger at bottom for text readability */}
        <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/60 to-transparent/10 pointer-events-none" />

        {/* Content Container */}
        <div class="relative z-10 w-full p-5 sm:p-8 md:p-12 text-white">
          {/* Category Tag */}
          <a href={`/blog?category=${post.category}`} class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-white/10 backdrop-blur-md border border-white/20 text-white hover:bg-white/20 transition-colors mb-4">
            {post.category}
          </a>

          {/* Title - text-balance for better wrapping, smaller mobile font */}
          <h1 class="text-2xl sm:text-3xl md:text-5xl lg:text-6xl font-extrabold leading-tight tracking-tight text-balance drop-shadow-sm mb-4">
            {post.title}
          </h1>

          {/* Meta Data */}
          <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm sm:text-base text-gray-200 font-medium">
            <span class="flex items-center gap-2">
              <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-white/20 flex items-center justify-center text-xs font-bold uppercase">
                {post.author.charAt(0)}
              </div>
              {post.author}
            </span>
            <span class="hidden sm:inline text-white/40">•</span>
            <span>{new Date(post.date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })}</span>
            {post.readTime && (
              <>
                <span class="hidden sm:inline text-white/40">•</span>
                <span class="flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  {post.readTime} min read
                </span>
              </>
            )}
          </div>
        </div>
      </div>

      {/* Layout: Content + TOC */}
      <div class="grid gap-10 lg:grid-cols-[minmax(0,1fr)_260px]">
        {/* Main Article */}
        <article class="min-w-0">
          <div class="article-content prose prose-lg dark:prose-invert max-w-none">
            <Content />
            
            {/* Inline Ad - Injected via React Portal/DOM manipulation or placed here */}
            <div class="mt-8">
               <AdsterraAd client:visible />
            </div>
          </div>

          {/* Author Box */}
          <div class="mt-10">
            <AuthorBox author={post.author} client:visible />
          </div>

          {/* Prev / Next */}
          {(prev || next) && (
            <nav class="mt-12 grid gap-4 border-t pt-6 md:grid-cols-2">
              {prev && (
                <a
                  href={`/blog/${prev.category}/${prev.slug}`}
                  class="block p-4 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800"
                >
                  <div class="text-xs text-gray-500">Previous</div>
                  <div class="font-semibold">{prev.title}</div>
                </a>
              )}
              {next && (
                <a
                  href={`/blog/${next.category}/${next.slug}`}
                  class="block p-4 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 md:text-right"
                >
                  <div class="text-xs text-gray-500">Next</div>
                  <div class="font-semibold">{next.title}</div>
                </a>
              )}
            </nav>
          )}

          {/* Share + Back */}
          <footer class="mt-12">
            <SocialShareButtons title={post.title} url={canonicalURL} client:visible />
            <div class="text-center mt-10">
              <a
                href="/blog"
                class="text-blue-600 dark:text-blue-400 hover:underline"
              >
                ← Back to Blog
              </a>
            </div>
          </footer>
        </article>

        {/* TOC Sidebar */}
        <aside class="hidden lg:block">
          <div class="sticky top-24 max-h-[70vh] overflow-y-auto border-l pl-4">
            <TOC client:load />
          </div>
        </aside>
      </div>
    </div>
  </main>
</Layout>
