---
import { Image } from "astro:assets";
import type { BlogPost } from "@/types";

interface Props {
    post: BlogPost;
    layout?: "grid" | "list";
    loading?: "eager" | "lazy";
}

const { post, layout = "grid", loading = "lazy" } = Astro.props;

const href = `/blog/${post.category}/${post.slug}`;
const isList = layout === "list";

const tagClassMap: Record<string, string> = {
    AI: "tag--indigo",
    coding: "tag--blue",
    drama: "tag--pink",
    film: "tag--purple",
    general: "tag--emerald",
    shopping: "tag--pink",
    health: "tag--emerald",
    news: "tag--blue",
};

// Helper to determine if image is remote (Unsplash) or local string path
const isUnsplash =
    typeof post.image === "string" &&
    post.image.includes("images.unsplash.com");
---

<article
    class={`card group flex ${isList ? "flex-row gap-6" : "flex-col"} overflow-hidden relative h-full`}
>
    {/* Thumbnail (CLS-safe) */}
    {
        post.image ? (
            <div
                class={`relative block overflow-hidden card-thumb ${isList ? "w-1/3 aspect-video" : "aspect-video"}`}
            >
                {/* 
                  Handle both remote strings (Unsplash) and local ImageMetadata objects 
                */}
                {typeof post.image === "string" ? (
                    <Image
                        src={post.image}
                        alt={post.title}
                        width={600}
                        height={338}
                        loading={loading}
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    />
                ) : (
                    <Image
                        src={post.image}
                        alt={post.title}
                        loading={loading}
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    />
                )}
            </div>
        ) : null
    }

    {/* Content Block */}
    <div class={`flex flex-col flex-1 p-5 ${isList ? "justify-center" : ""}`}>
        {/* Category Tag & Date */}
        <div class="flex items-center justify-between text-xs mb-3">
            <span class={`tag ${tagClassMap[post.category] ?? ""}`}>
                {post.category}
            </span>
            <time class="text-gray-500">
                {
                    new Date(post.date).toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                        year: "numeric",
                    })
                }
            </time>
        </div>

        {/* Blog Title */}
        <h3
            class="card-title brand-link transition-colors line-clamp-2 mb-2 text-lg md:text-xl"
        >
            <a
                href={href}
                class="after:absolute after:inset-0 focus:outline-none"
                aria-label={`Read ${post.title}`}
            >
                <span class="absolute inset-0" aria-hidden="true"></span>
                {post.title}
            </a>
        </h3>

        {/* Blog Excerpt */}
        <p class="card-desc text-sm leading-relaxed line-clamp-3 grow">
            {post.excerpt}
        </p>

        {/* Author + Read Time */}
        <div
            class="mt-4 flex items-center justify-between text-xs text-gray-500"
        >
            {/* Avatar alternative - initials circle */}
            <div class="flex items-center gap-2">
                <div
                    class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-200 text-gray-800 font-medium"
                >
                    {
                        post.author
                            .split(" ")
                            .map((n) => n[0])
                            .join("")
                    }
                </div>
                <span>{post.author}</span>
            </div>

            {post.readTime && <span>{post.readTime} min read</span>}
        </div>
    </div>
</article>
